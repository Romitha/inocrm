/ = product
- ticket = @ticket
- product = @product
= render "tickets/tickets_pack/ticket_header", ticket: ticket, product: product

= tab_panel do
  = tab_nav_tab({class: "small_scale_margin-bottom2"}, ticket_info: {content: "Ticket info"}, low_margin_estimate: {content: "Low margin estimate", active_class: "active"})
  .tab-content
    = tab_content tabpointer: :ticket_info do
      = tab_panel do
        = render "tickets/tickets_pack/ticket_info", ticket: ticket, product: product#, customer: customer, warranties: warranties, histories: histories, join_tickets: join_tickets, ge_q_and_as: ge_q_and_as, pr_q_and_as: pr_q_and_answers

    = tab_content tabpointer: :low_margin_estimate, active_class: "active" do

      .row
        .col-md-12
          = simple_nested_form_for ticket, url: update_low_margin_estimate_inventories_path, method: :put do |f|
            = hidden_field_tag :process_id, session[:process_id]
            = hidden_field_tag :task_id, session[:task_id]
            = hidden_field_tag :owner, session[:owner]
            - session[:bpm_input_variables].each do |bpm_input_variable|
              = hidden_field_tag bpm_input_variable[0], bpm_input_variable[1]

            = f.simple_fields_for "ticket_estimations_attributes[]", @estimation do |t|
              - if t.object.status_id == EstimationStatus.find_by_code("RQS").id and t.object.ticket_estimation_externals.present?
                = hidden_field_tag :ticket_estimation_id, t.object.id

                = t.simple_fields_for :ticket_estimation_externals do |te|
                  .row
                    = hidden_field_tag :ticket_estimation_external_id, te.object.id
                    .col-md-3

                      %strong Repaired by:
                      = te.object.organization.name
                    .col-md-2

                      %strong Cost price:
                      = te.object.cost_price
                    .col-md-2

                      %strong Estimated price:
                      = te.object.estimated_price
                    .col-md-2

                      %strong Warranty period:
                      = te.object.warranty_period
                    .col-md-3
                      = t.input :id, as: :hidden
                      %strong Approved amount:
                      = te.input :approved_estimated_price, label: false, input_html: {class: "approved_amount", oninput: "Inventories.calculate_approved_price();"}

                  .row
                    .col-md-12
                      %fieldset
                        %legend Estimation additionals

                        = t.simple_fields_for :ticket_estimation_additionals do |ta|
                          = ta.input :ticket_id, as: :hidden, input_html: {value: ticket.id}
                          .col-md-12
                            .row
                              .col-md-3.col-xs-3.col-sm-3
                                %strong Additional charge:
                                = ta.object.additional_charge.try(:additional_charge)
                              .col-md-3.col-xs-3.col-sm-3

                                %strong Cost price:
                                = ta.object.cost_price
                              .col-md-3.col-xs-3.col-sm-3

                                %strong Estimated price:
                                = ta.object.estimated_price
                              .col-md-3.col-xs-3.col-sm-3
                                = ta.input :approved_estimated_price, input_html: {class: "approved_estimate", oninput: "Inventories.calculate_approved_price();"}
                        .col-md-12
                          .row
                            .col-md-3.col-xs-3.col-sm-3
                            .col-md-3.col-xs-3.col-sm-3
                              %strong Cost price total:
                              = t.object.ticket_estimation_additionals.sum(:cost_price)
                            .col-md-3.col-xs-3.col-sm-3
                              %strong Estimated price total:
                              = t.object.ticket_estimation_additionals.sum(:estimated_price)
                            .col-md-3.col-xs-3.col-sm-3
                              %strong Approved price total:
                              %span#total_approved_amount
                              / = t.object.ticket_estimation_additionals.sum(:approved_estimated_price)

                  .row
                    .col-md-12
                      = t.input :note, input_html: {value: nil}
                      = simple_format @estimation.note
                  .row
                    .col-md-6
                      %strong Additional charge:
                      = t.object.advance_payment_amount
                    .col-md-6
                      = t.input :approved_adv_pmnt_amount

                = label_tag "Estimation complete"
                = check_box_tag :estimation_completed

                = f.submit "Save", class: "btn btn-success"