- ticket = @ticket
- product = @product
- warranties = @warranties
- customer = ticket.customer
- histories = @histories
- join_tickets = @join_tickets
- pr_q_and_answers = @q_and_answers
- ge_q_and_as = @ge_q_and_answers


%strong All Estimations
%table.table.table-responsive.table-condensed.table-bordered
  %thead
    %tr
      %th
      %th
      %th
      %th{colspan: 3, class: "text-center"} Estimated amount (#{ticket.ticket_currency.code})
    %tr
      %th No
      %th Requested date
      %th #{ticket.ticket_repair_type.code == 'EX' ? 'Repaired by' : 'No of parts' }
      %th #{ticket.ticket_repair_type.code == 'EX' ? 'Repair' : 'Parts' }
      %th Additional
      %th Total
      %th Min. advanced payment
      %th Estimation status

  %tbody
    - ticket.ticket_estimations.each_with_index do |estimation, index|
      %tr
        %td
          = link_to load_estimation_ticket_info_inventories_path(estimation_id: estimation.id, estimation_type: "#{ticket.ticket_repair_type.code == 'EX' ? 'external' : 'part' }"), remote: true do
            = index+1
        %td= estimation.requested_at
        %td
          - if ticket.ticket_repair_type.code == 'EX'
            = estimation.ticket_estimation_externals.first.try(:organization).try(:name)
          - else
            = estimation.ticket_estimation_parts.count
        %td
          - if estimation.approval_required
            - if ticket.ticket_repair_type.code == 'EX'
              = number_with_precision estimation.ticket_estimation_externals.sum(:approved_estimated_price), precision: 2
            - else
              = number_with_precision estimation.ticket_estimation_parts.sum(:approved_estimated_price), precision: 2
          - else
            - if ticket.ticket_repair_type.code == 'EX'
              = number_with_precision estimation.ticket_estimation_externals.sum(:estimated_price), precision: 2
            - else
              = number_with_precision estimation.ticket_estimation_parts.sum(:estimated_price), precision: 2

        %td
          - if estimation.approval_required
            = number_with_precision estimation.ticket_estimation_additionals.sum(:approved_estimated_price), precision: 2
          - else
            = number_with_precision estimation.ticket_estimation_additionals.sum(:estimated_price), precision: 2

        %td
          - if estimation.approval_required
            - if ticket.ticket_repair_type.code == 'EX'
              = number_with_precision(estimation.ticket_estimation_externals.sum(:approved_estimated_price) + estimation.ticket_estimation_additionals.sum(:approved_estimated_price), precision: 2)
            - else
              = number_with_precision(estimation.ticket_estimation_parts.sum(:approved_estimated_price) + estimation.ticket_estimation_additionals.sum(:approved_estimated_price), precision: 2)
          - else
            - if ticket.ticket_repair_type.code == 'EX'
              = number_with_precision(estimation.ticket_estimation_externals.sum(:estimated_price) + estimation.ticket_estimation_additionals.sum(:estimated_price), precision: 2)
            - else
              = number_with_precision(estimation.ticket_estimation_parts.sum(:estimated_price) + estimation.ticket_estimation_additionals.sum(:estimated_price), precision: 2)
        %td
          - if estimation.approval_required
            = number_with_precision estimation.approved_adv_pmnt_amount, precision: 2
          - else
            = number_with_precision estimation.advance_payment_amount, precision: 2
        %td= estimation.estimation_status.name

%strong Quotations
.row
  .col-md-12
    %table.table.table-responsive.table-condensed.table-bordered
      %thead
        %tr
          %th No
          %th Validity period
          %th Warranty
          %th Customer contacted
          %th Canceled
          %th Action

      %tbody
        - ticket.customer_quotations.each_with_index do |quotation, index|
          %tr
            %td
              = index+1
            %td.validity_period= quotation.try(:validity_period)
            %td= quotation.try(:warranty)
            %td= quotation.customer_contacted ? "Yes" : "No"
            %td= quotation.canceled ? "Yes" : "No"
            %td
              = link_to "#", onclick: "Users.request_printer_application('quotation', '#{quotation.id}', 'quotation_request_type', 'print_customer_quotation_tag_value', 'print_customer_quotation'); false;", id: "ticket_quotation", data: {disable_with: "Printing..."}, class: "btn btn-default" do
                = ticket.ticket_print_count.to_i > 0 ? "Re-Print Quotation" : "Print Quotation"

#estimation_ajax_frame_ticket_info