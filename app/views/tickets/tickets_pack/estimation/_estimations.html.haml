%strong All Estimations
%table.table.table-responsive.table-condensed.table-bordered
  %thead
    %tr
      %th
      %th
      %th
      %th{colspan: 3, class: "text-center"} Estimated amount (#{ticket.ticket_currency.code})
    %tr
      %th No
      %th Requested date
      %th Description
      %th #{ticket.ticket_repair_type.code == 'EX' ? 'Repaired by' : 'No of parts' }
      %th #{ticket.ticket_repair_type.code == 'EX' ? 'Repair' : 'Parts' }
      %th Additional
      %th Total
      %th Min. advanced payment
      %th Estimation status

  %tbody
    - ticket.ticket_estimations.each_with_index do |estimation, index|
      - estimation_external_present = estimation.ticket_estimation_externals.present?
      %tr
        %td
          = link_to load_estimation_inventories_path(estimation_id: estimation.id, estimation_type: "#{estimation_external_present ? 'external' : 'part' }", task_id: params[:task_id]), remote: true do
            = index+1
        %td= estimation.requested_at.getlocal.try(:strftime, "%b %d, %Y %H:%M")
        %td
          .has-popover{title: "Description", data: {"toggle" => "popover", "title" => "Popover title", "trigger" => "hover", "content" => (estimation_external_present ? estimation.ticket_estimation_externals.first.description : estimation.ticket_estimation_parts.first.ticket_spare_part.spare_part_description)}}= truncate (estimation_external_present ? estimation.ticket_estimation_externals.first.description : estimation.ticket_estimation_parts.first.ticket_spare_part.spare_part_description), length: 20
        %td
          - if estimation_external_present
            = estimation.ticket_estimation_externals.first.try(:organization).try(:name)
          - else
            = estimation.ticket_estimation_parts.count
        %td
          - if estimation.approval_required
            - if estimation_external_present
              = number_with_precision estimation.ticket_estimation_externals.sum(:approved_estimated_price), precision: 2
            - else
              = number_with_precision estimation.ticket_estimation_parts.sum(:approved_estimated_price), precision: 2
          - else
            - if estimation_external_present
              = number_with_precision estimation.ticket_estimation_externals.sum(:estimated_price), precision: 2
            - else
              = number_with_precision estimation.ticket_estimation_parts.sum(:estimated_price), precision: 2

        %td
          - if estimation.approval_required
            = number_with_precision estimation.ticket_estimation_additionals.sum(:approved_estimated_price), precision: 2
          - else
            = number_with_precision estimation.ticket_estimation_additionals.sum(:estimated_price), precision: 2

        %td
          - if estimation.approval_required
            - if estimation_external_present
              = number_with_precision(estimation.ticket_estimation_externals.sum(:approved_estimated_price) + estimation.ticket_estimation_additionals.sum(:approved_estimated_price), precision: 2)
            - else
              = number_with_precision(estimation.ticket_estimation_parts.sum(:approved_estimated_price) + estimation.ticket_estimation_additionals.sum(:approved_estimated_price), precision: 2)
          - else
            - if estimation_external_present
              = number_with_precision(estimation.ticket_estimation_externals.sum(:estimated_price) + estimation.ticket_estimation_additionals.sum(:estimated_price), precision: 2)
            - else
              = number_with_precision(estimation.ticket_estimation_parts.sum(:estimated_price) + estimation.ticket_estimation_additionals.sum(:estimated_price), precision: 2)
        %td
          - if estimation.approval_required
            = number_with_precision estimation.approved_adv_pmnt_amount, precision: 2
          - else
            = number_with_precision estimation.advance_payment_amount, precision: 2
        %td= estimation.estimation_status.name

#estimation_ajax_frame